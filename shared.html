<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Progress - Experience Points</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Shared Progress - Experience Points</h1>
            <p id="shared-by-info">Loading shared content...</p>
        </div>

        <div id="shared-content" class="main-content">
            <div class="section-container">
                <h2 id="activities-title" class="section-title">Activities</h2>
                <div id="skills-progress" class="progress-container"></div>
            </div>

            <div class="section-container">
                <h2 id="financial-title" class="section-title">Financial Goals</h2>
                <div id="financial-progress" class="progress-container"></div>
            </div>
        </div>

        <div id="loading" class="loading">
            <p>Loading shared content...</p>
        </div>

        <div id="error-container" class="error-container" style="display: none;">
            <p id="error-message">This content is no longer available or has expired.</p>
        </div>

        <div class="footer">
            <p><a href="index.html">Create your own progress tracker</a></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Extract share ID from URL 
            const urlParams = new URLSearchParams(window.location.search);
            let shareId = urlParams.get('share');
            let profileId = urlParams.get('profile');
            
            if (!shareId && !profileId) {
                showError('No share ID or profile ID provided');
                return;
            }

            try {
                let apiUrl;
                if (shareId) {
                    apiUrl = `/api/shared/${shareId}`;
                } else {
                    apiUrl = `/api/profile/public/${profileId}`;
                }

                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error('Failed to load shared content');
                }
                
                const data = await response.json();
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                // Show shared data
                renderSharedContent(data);
            } catch (error) {
                console.error('Error loading shared content:', error);
                showError('This content is no longer available or has expired');
            }
        });

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('shared-content').style.display = 'none';
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function renderSharedContent(data) {
            // Update the header with information about who shared this
            const sharedByInfo = document.getElementById('shared-by-info');
            sharedByInfo.textContent = `Shared by ${data.username}`;

            // Sort progress items by category
            const skills = data.goals.filter(item => !item.is_financial);
            const financialGoals = data.goals.filter(item => item.is_financial);

            // Hide sections if empty
            if (skills.length === 0) {
                document.getElementById('activities-title').parentElement.style.display = 'none';
            }
            if (financialGoals.length === 0) {
                document.getElementById('financial-title').parentElement.style.display = 'none';
            }

            // Render skills progress
            if (skills.length > 0) {
                renderProgress(document.getElementById('skills-progress'), skills, false);
            }

            // Render financial goals progress
            if (financialGoals.length > 0) {
                renderProgress(document.getElementById('financial-progress'), financialGoals, true);
            }
        }

        function renderProgress(container, items, isFinancial = false) {
            container.innerHTML = '';

            items.forEach(item => {
                const progressPercentage = (item.current_value / item.target_value) * 100;
                const percentage = Math.min(100, progressPercentage).toFixed(0);
                const level = calculateLevel(item.current_value, item.target_value);
                const isMastered = progressPercentage >= 100;

                // Get emoji for the activity
                const emoji = getEmojiForActivity(item.name);

                const progressItem = document.createElement('div');
                progressItem.className = `progress-item ${isMastered ? 'mastered' : ''}`;
                progressItem.setAttribute('data-id', item.id);
                progressItem.setAttribute('data-type', isFinancial ? 'financial' : 'skill');

                // Render label
                const labelDiv = document.createElement('div');
                labelDiv.className = 'progress-label';

                const nameSpan = document.createElement('span');
                nameSpan.innerHTML = `${emoji} ${item.name}`;
                labelDiv.appendChild(nameSpan);

                const valueSpan = document.createElement('span');
                if (isFinancial) {
                    // For financial goals, show formatted currency values
                    valueSpan.innerHTML = `${formatCurrency(item.current_value)}/${formatCurrency(item.target_value)}`;
                } else {
                    // For skill goals, show hours
                    valueSpan.innerHTML = `${item.current_value}/${item.target_value} hours`;
                }
                labelDiv.appendChild(valueSpan);

                progressItem.appendChild(labelDiv);

                // Render progress bar
                const progressBarContainer = document.createElement('div');
                progressBarContainer.className = 'progress-bar-container';

                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                progressBar.style.width = `${percentage}%`;

                // Add level markers
                for (let i = 1; i <= 9; i++) {
                    const levelMarker = document.createElement('div');
                    levelMarker.className = `level-marker level-${i} ${level >= i ? 'achieved' : ''}`;
                    levelMarker.style.left = `${i * 10}%`;
                    progressBarContainer.appendChild(levelMarker);
                }

                progressBarContainer.appendChild(progressBar);
                progressItem.appendChild(progressBarContainer);

                // Render level and percentage
                const progressMetaDiv = document.createElement('div');
                progressMetaDiv.className = 'progress-meta';
                
                const levelSpan = document.createElement('span');
                levelSpan.className = 'level';
                levelSpan.innerHTML = `Level ${level}`;
                progressMetaDiv.appendChild(levelSpan);
                
                const percentageSpan = document.createElement('span');
                percentageSpan.className = 'percentage';
                percentageSpan.innerHTML = `${percentage}%`;
                progressMetaDiv.appendChild(percentageSpan);
                
                progressItem.appendChild(progressMetaDiv);

                // Add to container
                container.appendChild(progressItem);
            });
        }

        function calculateLevel(current, target) {
            const percentage = (current / target) * 100;
            return Math.min(10, Math.max(1, Math.floor(percentage / 10) + 1));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP',
                notation: 'compact'
            }).format(amount);
        }

        function getEmojiForActivity(name) {
            const emojiMap = {
                'Tennis': 'üéæ',
                'BJJ': 'ü•ã',
                'Cycling': 'üö¥',
                'Skiing': '‚õ∑Ô∏è',
                'Padel': 'üèì',
                'Spanish': 'üá™üá∏',
                'Pilates': 'üßò',
                'Cooking': 'üç≥',
                'Debt Repayment': 'üí∞'
            };
            return emojiMap[name] || 'üìä';
        }
    </script>
</body>
</html>
